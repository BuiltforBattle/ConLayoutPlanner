<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Space Designer</title>
  <style>
    body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
    #sidebar { width: 250px; padding: 20px; background: #f4f4f4; border-right: 1px solid #ccc; overflow-y: auto; }
    #grid-container {
      flex: 1;
      position: relative;
      background: #fff;
      box-sizing: border-box;
      display: block;
      overflow: auto;
      position: relative;
      padding: 0;
    }
    #grid-wrapper {
      display: inline-block;
      border: 4px solid #000;
      background: #fdfdfd;
      margin: 20px 0;
      padding-left: 0;
      padding-right: 0;
      transition: padding 0.2s ease;
    }
    #grid-scroll-wrapper {
      width: max-content;
      height: max-content;
    }

    #grid { position: relative; display: grid; }
    .cell { border: .15px solid #ddd; box-sizing: border-box; }
    .booth { position: absolute; border: 2px solid #333; color: #000; font-size: 10px; display: flex; justify-content: center; align-items: center; overflow: hidden; cursor: grab; transform-origin: top left; }
    .Vendor { background: rgba(0, 128, 255, 0.5); }
    .Artist { background: rgba(0, 255, 128, 0.5); }
    .Guest { background: rgba(255, 128, 0, 0.5); }
    .Stage { background: rgba(255, 0, 128, 0.5); }
    .Food { background: rgba(255, 230, 0, 0.5); }
    .Photo { background: rgba(153, 102, 255, 0.5); }
    .Other { background: rgba(255, 255, 255, 0.8); }

    label, input, select, button { display: block; margin-bottom: 10px; width: 100%; }
    .booth {
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    #boothList { margin-top: 2px; font-size: 12px; }
    #boothList div { margin-bottom: 4px; }
    #boothList::-webkit-scrollbar {
      width: 6px;
    }
    #boothList::-webkit-scrollbar-thumb {
      background-color: #888;
      border-radius: 3px;
    }
    #customBoothBtn.active-custom {
      background: #007bff;
      color: white;
      border: 1px solid #005bb5;
    }
    .booth.selected {
      outline: 3px solid red;
      z-index: 999;
      cursor: grabbing;
    }
    .active-size {
      background: #007bff;
      color: #fff;
      border: 1px solid #005bb5;
    }
    button {
      border-radius: 4px;
      border: 1px solid #bbb;
      background: #fff;
    transition: background 0.2s ease;
    }
    button:hover {
      background: #f0f0f0;
    }
    .sidebar-heading {
      font-size: 18px;
      margin: 16px 0 6px;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }
    #resizer {
      width: 5px;
      cursor: col-resize;
      background-color: #ccc;
      height: 100%;
    }
    label {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    body.noselect,
    body.noselect * {
      user-select: none;
    }
    #selectionBox {
      position: absolute;
      border: 2px dashed #007bff;
      background: rgba(0, 123, 255, 0.2);
      display: none;
      z-index: 9999;
      pointer-events: none;
    }
    .text-label {
      position: absolute;
      background: #ffe680;
      border: 1px solid #999;
      padding: 4px 8px;
      font-size: 12px;
      cursor: move;
      user-select: text;
      z-index: 5000;
      min-width: 40px;
      min-height: 20px;
    }
    .text-label.selected {
      outline: 2px dashed red;
    }
  </style>
</head>
<body>
  <header style="background:#222;color:#fff;text-align:center;padding:12px 0;font-size:1.4em;font-weight:bold;">Event Space Designer</header>
  <main style="flex: 1; display: flex; overflow: hidden;">
  <div id="sidebar">
    <h3 class="sidebar-heading">GRID TOOLS</h3>
    <strong style="font-size: 12px;">Floor Space Size (ft):</strong><br>
    <label>Width (ft): <input type="number" id="inputWidth" value="1"></label>
    <label>Length (ft): <input type="number" id="inputLength" value="1"></label>
    <div style="display: flex; justify-content: space-between; gap: 5px;">
      <button onclick="generateGrid()">Create Grid</button>
      <button onclick="toggleGridOpacity()" id="gridToggleBtn">Hide Grid Lines</button>
    </div>
    <hr>
    <h3 class="sidebar-heading">BOOTH SIZING</h3>
    <strong style="font-size: 12px;">Custom Space Size (ft):</strong><br>
    <input type="number" id="customWidth" placeholder="Width (ft)" min="2" step="2">
    <input type="number" id="customHeight" placeholder="Height (ft)" min="2" step="2">
    <div style="margin-bottom: 10px;">
  <strong style="font-size: 12px;">Quick Sizes:</strong><br>
  <div style="display: flex; gap: 5px; margin-bottom: 5px;">
    <button type="button" class="quick-size" onclick="setBoothSize(6, 6)" style="flex: 1 1 33%; font-size: 12px; padding: 2px;">6x6</button>
    <button type="button" class="quick-size" onclick="setBoothSize(8, 8)" style="flex: 1 1 33%; font-size: 12px; padding: 2px;">8x8</button>
    <button type="button" class="quick-size" onclick="setBoothSize(10, 10)" style="flex: 1 1 33%; font-size: 12px; padding: 2px;">10x10</button>
  </div>
  <div style="display: flex; gap: 5px; margin-bottom: 10px;">
    <button type="button" class="quick-size" onclick="setBoothSize(10, 20)" style="flex: 1 1 50%; font-size: 12px; padding: 2px;">10x20</button>
    <button type="button" class="quick-size" onclick="setBoothSize(20, 10)" style="flex: 1 1 50%; font-size: 12px; padding: 2px;">20x10</button>
  </div>
  <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; margin-bottom: 10px;">
    <input type="checkbox" id="multiPlaceToggle">
    <label for="multiPlaceToggle" style="margin: 0;">Multi-Place Mode</label>
  </div>
    <button id="customBoothBtn" onclick="enablePlacement(true)" style="flex: 1 1 50%; font-size: 12px; padding: 4px;">Place Custom Booth</button>  
</div>
    <label>Booth Type:
      <select id="boothType">
        <option value="Vendor">Vendor</option>
        <option value="Artist">Artist</option>
        <option value="Guest">Guest</option>
        <option value="Stage">Stage</option>
        <option value="Food">Food</option>
        <option value="Photo">Photo Op</option>
        <option value="Other">Other</option>
      </select>
    </label>
    <label>Label: <input type="text" id="boothLabel" placeholder="e.g. Vendor A1"></label>
    <hr>
    <h3 class="sidebar-heading">LAYOUT ACTIONS</h3>
    <div style="display: flex; justify-content: space-between; gap: 5px; margin-bottom: 10px;">
      <button onclick="scrollToCenter()" title="Center View" style="padding: 4px 6px; font-size: 12px; width: 33%;">Center View</button>
      <button onclick="duplicateSelectedBooth()" title="Duplicate Booth" style="padding: 4px 6px; font-size: 20px; width: 33%;">üìÑ</button>
      <button onclick="deleteSelectedBooth()" title="Delete Booth" style="padding: 4px 6px; font-size: 20px; width: 33%;">üóëÔ∏è</button>
    </div>
    <div style="display: flex; justify-content: space-between; gap: 5px;">
      <button onclick="saveLayout()" title="Save Layout" style="padding: 4px 6px; font-size: 20px; width: 33%;">üíæ</button>
      <button onclick="loadLayout()" title="Load Layout" style="padding: 4px 6px; font-size: 20px; width: 33%;">üìÇ</button>
    <button onclick="exportToPDF()" title="Export as PDF" style="padding: 4px 6px; font-size: 20px; width: 33%;">üìÑ</button>
    </div>
    <div style="display: flex; justify-content: space-between; gap: 5px; margin-top: 10px;">
      <button onclick="undoLayout()" style="width: 48%;">Undo</button>
      <button onclick="redoLayout()" style="width: 48%;">Redo</button>
      <button onclick="placeTextLabel()" style="margin-bottom: 10px;">üìç Place Text Label</button>
    </div>
    <hr>
    <label>Zoom:
      <input type="range" id="zoomSlider" min="0.5" max="2" step="0.1" value="1" onchange="updateZoom()">
    </label>
    <hr>
    <h3 class="sidebar-heading">BOOTH MANAGEMENT</h3>
    <div id="boothCount" style="font-size: 12px; font-style: italic; margin-bottom: 4px;"></div>
    <strong style="font-size: 12px;">Booth List:</strong>
    <div style="max-height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; background: #fff; margin-top: 4px; margin-bottom: 12px;">
      <div id="boothList"></div>
    </div>
    <label for="searchBooths">Search Booths:</label>
    <input type="text" id="searchBooths" placeholder="Type to search..." oninput="filterBoothList()" style="margin-bottom: 10px;">
    <button onclick="exportBoothListToCSV()" title="Export Booth List CSV" style="padding: 4px 6px; font-size: 14px; margin-top: 10px;">‚¨á Export Booth List CSV</button>
  </div>
  <div id="resizer"></div>
  <div id="grid-container">
    <div id="grid-scroll-wrapper">
    <div id="selectionBox"></div>
      <div id="grid-wrapper">
        <div id="grid"></div>
      </div>
    </div>
  </div>

  <div id="editModal" style="display: none; position: fixed; top: 30%; left: 50%; transform: translateX(-50%); background: #fff; padding: 16px; border: 2px solid #333; z-index: 10000; width: 280px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
    <label for="editLabel">Booth Label:</label>
    <input type="text" id="editLabel" style="margin-bottom: 10px;">
  
    <label for="editType">Booth Type:</label>
    <select id="editType" style="margin-bottom: 12px;">
      <option value="Vendor">Vendor</option>
      <option value="Artist">Artist</option>
      <option value="Guest">Guest</option>
      <option value="Stage">Stage</option>
      <option value="Food">Food</option>
      <option value="Photo">Photo</option>
      <option value="Other">Other</option>
    </select>

    <div style="display: flex; justify-content: space-between;">
      <button onclick="saveBoothEdits()">Save</button>
      <button onclick="closeEditModal()">Cancel</button>
    </div>
  </div>

  <script>
    const cellSizeFt = 2;
    const cellPx = 20;
    let isPlacing = false;
    let selectedBooth = null;
    
    window.addEventListener('keydown', e => {
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault(); // Prevent page scrolling from arrow keys
      }
    }, { passive: false });

    let boothCounter = 0;
    let boothWidth = 5;
    let boothHeight = 5;
    let history = [];
    let redoStack = [];
    let currentZoom = 1;
    let gridVisible = true;
    let editingBooth = null;
    const originalMouseMove = (moveEvent, booth, offsetX, offsetY, grid) => {
      const rect = grid.getBoundingClientRect();
      const x = (moveEvent.clientX - rect.left) / currentZoom - offsetX;
      const y = (moveEvent.clientY - rect.top) / currentZoom - offsetY;
      const snappedLeft = Math.round(x / cellPx) * cellPx;
      const snappedTop = Math.round(y / cellPx) * cellPx;

      const boothWidth = parseInt(booth.style.width);
      const boothHeight = parseInt(booth.style.height);
      const gridWidth = grid.offsetWidth;
      const gridHeight = grid.offsetHeight;

      const withinBounds = snappedLeft >= 0 && snappedTop >= 0 &&
                          snappedLeft + boothWidth <= gridWidth &&
                          snappedTop + boothHeight <= gridHeight;

      const otherBooths = Array.from(document.querySelectorAll('.booth')).filter(b => b !== booth);
      const overlapping = otherBooths.some(b => {
        const bx = parseInt(b.style.left);
        const by = parseInt(b.style.top);
        const bw = parseInt(b.style.width);
        const bh = parseInt(b.style.height);
        return snappedLeft < bx + bw && snappedLeft + boothWidth > bx &&
               snappedTop < by + bh && snappedTop + boothHeight > by;
      });

      if (withinBounds && !overlapping) {
        booth.style.transform = `translate(${snappedLeft}px, ${snappedTop}px)`;

        // OPTIONAL: if you want to also retain booth.style.left/top for saving/exporting layout info:
        booth.dataset.translateX = snappedLeft;
        booth.dataset.translateY = snappedTop;
      }
    };

    let isSelecting = false;
    let startX, startY;
    const selectionBox = document.getElementById('selectionBox');
    const gridWrapper = document.getElementById('grid-wrapper');

    gridWrapper.addEventListener('mousedown', function(e) {
      if (!e.shiftKey) return;

      isSelecting = true;
      const rect = gridWrapper.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;

      selectionBox.style.left = `${startX}px`;
      selectionBox.style.top = `${startY}px`;
      selectionBox.style.width = '0px';
      selectionBox.style.height = '0px';
      selectionBox.style.display = 'block';
    });

    gridWrapper.addEventListener('mousemove', function(e) {
      if (!isSelecting) return;
      const rect = gridWrapper.getBoundingClientRect();
      const currentX = e.clientX - rect.left;
      const currentY = e.clientY - rect.top;

      const x = Math.min(startX, currentX);
      const y = Math.min(startY, currentY);
      const w = Math.abs(currentX - startX);
      const h = Math.abs(currentY - startY);

      selectionBox.style.left = `${x}px`;
      selectionBox.style.top = `${y}px`;
      selectionBox.style.width = `${w}px`;
      selectionBox.style.height = `${h}px`;

      const boxRect = selectionBox.getBoundingClientRect();
      const booths = document.querySelectorAll('.booth');
      booths.forEach(booth => {
        const boothRect = booth.getBoundingClientRect();
        const intersects =
          boxRect.left < boothRect.right &&
          boxRect.right > boothRect.left &&
          boxRect.top < boothRect.bottom &&
          boxRect.bottom > boothRect.top;

        if (intersects) {
          booth.classList.add('selected');
        }
      });
    });

    document.addEventListener('mouseup', (e) => {
      if (isSelecting) {
        e.preventDefault();
        isSelecting = false;
        selectionBox.style.display = 'none';
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Delete') {
        if (selectedBooth) {
          selectedBooth.remove();
          selectedBooth = null;
          updateBoothList();
          saveHistory();
        } else {
          const selectedLabel = document.querySelector('.text-label.selected');
          if (selectedLabel) {
            selectedLabel.remove();
          }
        }
      }

      // ‚úÖ Escape key works globally
    if (e.key === 'Escape') {
        isPlacing = false;
        document.querySelectorAll('.quick-size').forEach(btn => btn.classList.remove('active-size'));
        document.getElementById('multiPlaceToggle').checked = false;
        document.getElementById('customBoothBtn').classList.remove('active-custom');
      }

      if (selectedBooth) {
        const step = cellPx;
        let x = parseInt(selectedBooth.dataset.translateX || 0);
        let y = parseInt(selectedBooth.dataset.translateY || 0);

        if (e.key === 'ArrowUp') {
          e.preventDefault();
          y -= step;
        }
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          y += step;
        }
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          x -= step;
        }
        if (e.key === 'ArrowRight') {
          e.preventDefault();
          x += step;
        }
        // Ctrl+Z = Undo, Ctrl+Y = Redo
        if (e.ctrlKey && e.key === 'z') {
          e.preventDefault();
          undoLayout();
        }
        if (e.ctrlKey && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) {
          e.preventDefault();
          redoLayout();
        }
        if (e.ctrlKey && e.key === 'a') {
          e.preventDefault();
          document.querySelectorAll('.booth').forEach(b => b.classList.add('selected'));
        }

        selectedBooth.style.transform = `translate(${x}px, ${y}px)`;
        selectedBooth.dataset.translateX = x;
        selectedBooth.dataset.translateY = y;
      }
    });
    
    function throttle(callback, limit) {
      let waiting = false;
      return function () {
        if (!waiting) {
          callback.apply(this, arguments);
          waiting = true;
          setTimeout(() => {
            waiting = false;
          }, limit);
        }
      };
    }
    
    function attachThrottledMouseEvents(booth, offsetX, offsetY, grid) {
      const selectedBooths = Array.from(document.querySelectorAll('.booth.selected'));

      const boothOffsets = selectedBooths.map(b => {
        const bx = parseInt(b.dataset.translateX || 0);
        const by = parseInt(b.dataset.translateY || 0);
        return { booth: b, offsetX: bx - (parseInt(booth.dataset.translateX || 0)), offsetY: by - (parseInt(booth.dataset.translateY || 0)) };
      });

      const throttledMouseMove = throttle((moveEvent) => {
        const rect = grid.getBoundingClientRect();
        const mouseX = (moveEvent.clientX - rect.left) / currentZoom - offsetX;
        const mouseY = (moveEvent.clientY - rect.top) / currentZoom - offsetY;
        const snappedX = Math.round(mouseX / cellPx) * cellPx;
        const snappedY = Math.round(mouseY / cellPx) * cellPx;

        boothOffsets.forEach(({ booth: b, offsetX, offsetY }) => {
          const newX = snappedX + offsetX;
          const newY = snappedY + offsetY;
          b.style.transform = `translate(${newX}px, ${newY}px)`;
          b.dataset.translateX = newX;
          b.dataset.translateY = newY;
        });
      }, 16);

      function onMouseUp() {
        document.removeEventListener('mousemove', throttledMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.body.classList.remove('noselect');
      }

      document.body.classList.add('noselect');
      document.addEventListener('mousemove', throttledMouseMove);
      document.addEventListener('mouseup', onMouseUp);
    }
    
    function generateGrid() {
      const widthFt = parseInt(document.getElementById('inputWidth').value);
      const lengthFt = parseInt(document.getElementById('inputLength').value);
      const cols = Math.floor(widthFt / cellSizeFt);
      const rows = Math.floor(lengthFt / cellSizeFt);

      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      grid.style.gridTemplateColumns = `repeat(${cols}, ${cellPx}px)`;
      grid.style.gridTemplateRows = `repeat(${rows}, ${cellPx}px)`;
      grid.style.width = `${cols * cellPx}px`;
      grid.style.height = `${rows * cellPx}px`;

      for (let i = 0; i < rows * cols; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        grid.appendChild(cell);

        document.getElementById('gridToggleBtn').textContent = gridVisible ? 'Hide Grid Lines' : 'Show Grid Lines';
      }
    }

    function enablePlacement(isCustom = false) {
      isPlacing = true;
      // Clear any active quick-size buttons
      document.querySelectorAll('.quick-size').forEach(btn => btn.classList.remove('active-size'));

      // Highlight the custom button
      document.getElementById('customBoothBtn').classList.add('active-custom');

      const grid = document.getElementById('grid');
      const type = document.getElementById('boothType').value;
      const label = document.getElementById('boothLabel').value;
      let w = 5, h = 5;

      if (isCustom) {
        const customW = parseInt(document.getElementById('customWidth').value);
        const customH = parseInt(document.getElementById('customHeight').value);
        if (!isNaN(customW)) boothWidth = customW;
        if (!isNaN(customH)) boothHeight = customH;
      }

      grid.onclick = function(e) {
        if (!isPlacing || !e.target.classList.contains('cell')) return;
        if (!document.getElementById('multiPlaceToggle').checked) {
          isPlacing = false;
        }

        const rect = grid.getBoundingClientRect();
        const x = (e.clientX - rect.left) / currentZoom;
        const y = (e.clientY - rect.top) / currentZoom;
        const left = Math.round(x / cellPx) * cellPx;
        const top = Math.round(y / cellPx) * cellPx;

        const booth = document.createElement('div');
        const w = boothWidth / cellSizeFt;
        const h = boothHeight / cellSizeFt;
        const type = document.getElementById('boothType').value;
        const label = document.getElementById('boothLabel').value;
        
        booth.className = `booth ${type}`;
        booth.style.transform = `translate(${left}px, ${top}px)`;
        booth.dataset.translateX = left;
        booth.dataset.translateY = top;
        booth.style.width = `${w * cellPx}px`;
        booth.style.height = `${h * cellPx}px`;
        booth.textContent = label || `${w * cellSizeFt}x${h * cellSizeFt}`;
        booth.setAttribute('tabindex', 0);
        booth.dataset.rotation = 0;
        booth.dataset.label = label;
        booth.dataset.type = type;
        booth.dataset.index = ++boothCounter;

        booth.addEventListener('click', function(ev) {
          if (ev.shiftKey) {
            booth.classList.toggle('selected');
          } else {
            document.querySelectorAll('.booth.selected').forEach(b => b.classList.remove('selected'));
            booth.classList.add('selected');
          }
            selectedBooth = booth;

          ev.stopPropagation();
        });

        booth.addEventListener('mousedown', function(ev) {
          if (!ev.shiftKey && !booth.classList.contains('selected')) {
            document.querySelectorAll('.booth.selected').forEach(b => b.classList.remove('selected'));
            booth.classList.add('selected');
            selectedBooth = booth;
          }
          const boothRect = booth.getBoundingClientRect();
          const offsetX = (ev.clientX - boothRect.left) / currentZoom;
          const offsetY = (ev.clientY - boothRect.top) / currentZoom;
          const grid = document.getElementById('grid');
          attachThrottledMouseEvents(booth, offsetX, offsetY, grid);
        });
        
        booth.addEventListener('dblclick', function () {
          editLabel(booth.dataset.index);
        });

        grid.appendChild(booth);
        updateBoothList();
        saveHistory();
      }
    }

    function setBoothSize(width, height) {
      document.getElementById('customBoothBtn').classList.remove('active-custom');
      document.getElementById('customWidth').value = width;
      document.getElementById('customHeight').value = height;
      boothWidth = width;
      boothHeight = height;

      // ‚úÖ Highlight the selected button
      document.querySelectorAll('.quick-size').forEach(btn => btn.classList.remove('active-size'));
      const buttons = document.querySelectorAll('.quick-size');
      buttons.forEach(btn => {
        if (btn.textContent === `${width}x${height}`) {
          btn.classList.add('active-size');
        }
      });

      enablePlacement(true);
    }

    function deleteSelectedBooth() {
      if (selectedBooth) {
        selectedBooth.remove();
        selectedBooth = null;
        updateBoothList();
        saveHistory();
      }
    }

    function updateBoothList() {
      const boothList = document.getElementById('boothList');
      const search = document.getElementById('searchBooths')?.value.toLowerCase() || '';
      boothList.innerHTML = '';

      const booths = Array.from(document.querySelectorAll('.booth'));
      const countText = booths.length === 1 ? '1 booth placed' : `${booths.length} booths placed`;
      let vendorCount = 0;
      let artistCount = 0;
      let guestCount = 0;

      booths.forEach(booth => {
        const type = booth.dataset.type;
        if (type === 'Vendor') vendorCount++;
        else if (type === 'Artist') artistCount++;
        else if (type === 'Guest') guestCount++;
      });

      const total = vendorCount + artistCount + guestCount;

      document.getElementById('boothCount').innerHTML = `
        <strong>${total} Featured Booth${total === 1 ? '' : 's'} Placed</strong><br>
        <span style="color:#0078d4;">Vendors:</span> ${vendorCount} &nbsp; 
        <span style="color:#00a859;">Artists:</span> ${artistCount} &nbsp; 
        <span style="color:#e67e22;">Guests:</span> ${guestCount}
      `;

      // Group booths by type
      const groups = {};
      booths.forEach(booth => {
        const type = booth.dataset.type || 'Other';
        if (!groups[type]) groups[type] = [];
        groups[type].push(booth);
      });

      // Sort groups alphabetically
      let html = '';

      Object.keys(groups).sort().forEach(type => {
        const matchingBooths = groups[type].filter(booth => {
          const label = booth.dataset.label?.toLowerCase() || booth.textContent.toLowerCase();
          return label.includes(search) || type.toLowerCase().includes(search);
        });

        if (matchingBooths.length > 0) {
          const groupId = `group-${type.replace(/\s+/g, '-')}`;
          html += `
            <div class="booth-group-header" onclick="toggleBoothGroup('${groupId}')" style="margin-top: 8px; font-weight: bold; cursor: pointer;">
              <span class="toggle-arrow" id="arrow-${groupId}">‚ñ∂</span> ${type}
            </div>
            <div id="${groupId}" style="margin-left: 10px; display: none;">
          `;

          matchingBooths.forEach(booth => {
            const id = booth.dataset.index;
            const label = booth.dataset.label || booth.textContent;
            html += `
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="cursor: pointer;" onclick="highlightBooth(${id})">#${id}: ${label}</span>
                <button onclick="editLabel(${id})" title="Rename Booth"
                  style="font-size: 16px; width: 24px; height: 24px; padding: 0; line-height: 1; margin-left: 5px; text-align: center;">‚úèÔ∏è</button>
              </div>`;
          });

          html += `</div>`;
        }
      });

      boothList.innerHTML = html;
    }

    function toggleBoothGroup(groupId) {
      const group = document.getElementById(groupId);
      if (!group) return;

      const isVisible = group.style.display !== 'none';
      group.style.display = isVisible ? 'none' : 'block';

      const arrow = document.getElementById(`arrow-${groupId}`);
      if (arrow) {
        arrow.textContent = isVisible ? '‚ñ∂' : '‚ñº';
      }
    }

    function highlightBooth(index) {
      const booth = Array.from(document.querySelectorAll('.booth')).find(b => b.dataset.index == index);
      if (!booth) return;

      // Flash the booth with a yellow outline briefly
      booth.style.outline = '3px solid gold';
      booth.style.zIndex = 1000;

      setTimeout(() => {
        booth.style.outline = '';
        booth.style.zIndex = '';
      }, 1200);
    }

    function filterBoothList() {
      updateBoothList(); // will respect the live search filter
    }

    function editLabel(index) {
      const booth = Array.from(document.querySelectorAll('.booth')).find(b => b.dataset.index == index);
      if (!booth) return;

    editingBooth = booth;

      document.getElementById('editLabel').value = booth.dataset.label || booth.textContent;
      document.getElementById('editType').value = booth.dataset.type;

      document.getElementById('editModal').style.display = 'block';
    }

    function saveBoothEdits() {
      if (!editingBooth) return;

      const newLabel = document.getElementById('editLabel').value.trim();
      const newType = document.getElementById('editType').value;
      const currentType = editingBooth.dataset.type;

      if (newLabel) {
        editingBooth.dataset.label = newLabel;
        editingBooth.textContent = newLabel;
      }

      if (newType !== currentType) {
        editingBooth.classList.remove(currentType);
        editingBooth.classList.add(newType);
        editingBooth.dataset.type = newType;
      }

      document.getElementById('editModal').style.display = 'none';
      editingBooth = null;
      updateBoothList();
      saveHistory();
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      editingBooth = null;
    }
  
    function updateZoom() {
      currentZoom = parseFloat(document.getElementById('zoomSlider').value);
      const wrapper = document.getElementById('grid-wrapper');
      const grid = document.getElementById('grid');
      const container = document.getElementById('grid-container');

      wrapper.style.transform = `scale(${currentZoom})`;
      wrapper.style.transformOrigin = 'top left';

      // Calculate scaled width
      const scaledWidth = grid.offsetWidth * currentZoom;
      const containerWidth = container.clientWidth;

      // Add horizontal padding to center the zoomed grid
      const sidePadding = Math.max((containerWidth - scaledWidth) / 2, 0);
      wrapper.style.paddingLeft = `${sidePadding}px`;
      wrapper.style.paddingRight = `${sidePadding}px`;
    }

    function toggleGridOpacity() {
      const cells = document.querySelectorAll('.cell');
      gridVisible = !gridVisible;

      cells.forEach(cell => {
        cell.style.borderColor = gridVisible ? 'rgba(0, 0, 0, 0.2)' : 'transparent';
      });

      const btn = document.getElementById('gridToggleBtn');
      btn.textContent = gridVisible ? 'Hide Grid Lines' : 'Show Grid Lines';
    }

    function saveLayout() {
      const booths = Array.from(document.querySelectorAll('.booth')).map(booth => ({
        translateX: booth.dataset.translateX || 0,
        translateY: booth.dataset.translateY || 0,
        width: booth.style.width,
        height: booth.style.height,
        rotation: booth.dataset.rotation || 0,
        label: booth.dataset.label || '',
        type: booth.dataset.type || '',
        index: booth.dataset.index || ''
      }));
      localStorage.setItem('cosplayLayout', JSON.stringify(booths));
      alert('Layout saved!');
    }

    function loadLayout() {
      const saved = localStorage.getItem('cosplayLayout');
      if (!saved) return alert('No saved layout found.');
      const booths = JSON.parse(saved);

      const grid = document.getElementById('grid');
      grid.innerHTML = ''; // Clear current layout
      generateGrid(); // Redraw grid

      booths.forEach(data => {
        const booth = document.createElement('div');
        booth.className = `booth ${data.type}`;
        booth.dataset.translateX = data.translateX;
        booth.dataset.translateY = data.translateY;
        booth.style.transform = `translate(${data.translateX}px, ${data.translateY}px) rotate(${data.rotation}deg)`;
        booth.style.width = data.width;
        booth.style.height = data.height;
        booth.textContent = data.label;
        booth.setAttribute('tabindex', 0);
        booth.dataset.rotation = data.rotation;
        booth.dataset.label = data.label;
        booth.dataset.type = data.type;
        booth.dataset.index = data.index;
    
        booth.addEventListener('click', function(ev) {
          if (ev.shiftKey) {
            booth.classList.toggle('selected');
          } else {
            document.querySelectorAll('.booth.selected').forEach(b => b.classList.remove('selected'));
            booth.classList.add('selected');
          }
          selectedBooth = booth;
          ev.stopPropagation();
        });

        booth.addEventListener('mousedown', function(ev) {
          const boothRect = booth.getBoundingClientRect();
          const offsetX = (ev.clientX - boothRect.left) / currentZoom;
          const offsetY = (ev.clientY - boothRect.top) / currentZoom;
          const grid = document.getElementById('grid');
          attachThrottledMouseEvents(booth, offsetX, offsetY, grid);
        });

        booth.addEventListener('dblclick', function () {
          editLabel(booth.dataset.index);
        });

        grid.appendChild(booth);
      });

      updateBoothList();
    }

    function exportToPDF() {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("jsPDF is not loaded.");
        return;
      }

      const jsPDF = window.jspdf.jsPDF;

      html2canvas(document.getElementById('grid-wrapper')).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF({
          orientation: 'landscape',
          unit: 'px',
          format: [canvas.width, canvas.height]
        });

        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save('layout.pdf');
      }).catch(err => {
        console.error('html2canvas error:', err);
        alert('Failed to export layout. See console for details.');
      });
    }

    function exportBoothListToCSV() {
      const booths = Array.from(document.querySelectorAll('.booth'));

      const rows = [["Index", "Type", "Label", "Width (ft)", "Height (ft)", "X (ft)", "Y (ft)"]];

      booths.forEach(booth => {
        const index = booth.dataset.index;
        const type = booth.dataset.type;
      const label = booth.dataset.label || booth.textContent;

        const widthPx = parseInt(booth.style.width);
        const heightPx = parseInt(booth.style.height);
        const xPx = parseInt(booth.style.left);
        const yPx = parseInt(booth.style.top);

        const widthFt = (widthPx / cellPx) * cellSizeFt;
        const heightFt = (heightPx / cellPx) * cellSizeFt;
        const xFt = (xPx / cellPx) * cellSizeFt;
        const yFt = (yPx / cellPx) * cellSizeFt;

        rows.push([index, type, label, widthFt, heightFt, xFt, yFt]);
      });

      const csvContent = rows.map(row => row.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "booth-list.csv");
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function scrollToCenter() {
      const container = document.getElementById('grid-container');
      const wrapper = document.getElementById('grid-wrapper');

      const scrollLeft = (wrapper.offsetWidth * parseFloat(document.getElementById('zoomSlider').value) - container.clientWidth) / 2;
      container.scrollLeft = scrollLeft;
    }

    function duplicateSelectedBooth() {
    if (!selectedBooth) return;

    const original = selectedBooth;
    const clone = original.cloneNode(true);
    const grid = document.getElementById('grid');

    const left = parseInt(original.dataset.translateX || 0) + 80;
    const top = parseInt(original.dataset.translateY || 0) + 0;
    clone.style.transform = `translate(${left}px, ${top}px)`;
    clone.dataset.translateX = left;
    clone.dataset.translateY = top;

    clone.dataset.index = ++boothCounter;
    clone.setAttribute('tabindex', 0);
    const w = parseInt(clone.style.width) / cellPx * cellSizeFt;
    const h = parseInt(clone.style.height) / cellPx * cellSizeFt;
    const label = original.dataset.label;
    clone.textContent = label && label.trim() !== "" ? label : `${w}x${h}`;
    clone.dataset.label = label || "";


    clone.addEventListener('click', function(ev) {
      if (ev.shiftKey) {
        clone.classList.toggle('selected');
      } else {
        document.querySelectorAll('.booth.selected').forEach(b => b.classList.remove('selected'));
        clone.classList.add('selected');
      }
      selectedBooth = clone;
      ev.stopPropagation();
    });

    clone.addEventListener('mousedown', function(ev) {
      const boothRect = clone.getBoundingClientRect();
      const offsetX = (ev.clientX - boothRect.left) / currentZoom;
      const offsetY = (ev.clientY - boothRect.top) / currentZoom;
      const grid = document.getElementById('grid');
      attachThrottledMouseEvents(clone, offsetX, offsetY, grid);
    });
    clone.addEventListener('dblclick', function () {
      editLabel(clone.dataset.index);
    });
      
      grid.appendChild(clone);
      updateBoothList();
      saveHistory();
    }

    function saveHistory() {
      const snapshot = Array.from(document.querySelectorAll('.booth')).map(booth => ({
        translateX: booth.dataset.translateX,
        translateY: booth.dataset.translateY,
        width: booth.style.width,
        height: booth.style.height,
        rotation: booth.dataset.rotation,
        label: booth.dataset.label,
        type: booth.dataset.type,
      index: booth.dataset.index
      }));

      history.push(snapshot);
      if (history.length > 50) history.shift(); // Limit history size
      redoStack = []; // Clear redo stack on new action
    }

    function undoLayout() {
      if (history.length < 2) return; // Need at least 2 to go back

      const current = history.pop();         // Remove current
      redoStack.push(current);               // Save to redo
      const previous = history[history.length - 1];  // Peek previous
      restoreLayout(previous);
    }

    function redoLayout() {
      if (redoStack.length === 0) return;

      const next = redoStack.pop();          // Redo state
      history.push(next);                    // Put it back into history
      restoreLayout(next);
    }

    function restoreLayout(layout) {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      generateGrid();

      layout.forEach(data => {
        const booth = document.createElement('div');
        booth.className = `booth ${data.type}`;
        booth.dataset.translateX = data.translateX;
        booth.dataset.translateY = data.translateY;
        booth.style.transform = `translate(${data.translateX}px, ${data.translateY}px) rotate(${data.rotation}deg)`;
        booth.style.width = data.width;
        booth.style.height = data.height;
        const w = parseInt(data.width) / cellPx * cellSizeFt;
        const h = parseInt(data.height) / cellPx * cellSizeFt;
        booth.textContent = data.label && data.label.trim() !== "" ? data.label : `${w}x${h}`;
        booth.setAttribute('tabindex', 0);
        booth.dataset.rotation = data.rotation;
        booth.dataset.label = data.label;
        booth.dataset.type = data.type;
        booth.dataset.index = data.index;

        booth.addEventListener('click', function(ev) {
          if (ev.shiftKey) {
            booth.classList.toggle('selected');
          } else {
            document.querySelectorAll('.booth.selected').forEach(b => b.classList.remove('selected'));
            booth.classList.add('selected');
          }
          selectedBooth = booth;
          ev.stopPropagation();
        });

        booth.addEventListener('mousedown', function(ev) {
          const boothRect = booth.getBoundingClientRect();
          const offsetX = (ev.clientX - boothRect.left) / currentZoom;
          const offsetY = (ev.clientY - boothRect.top) / currentZoom;
          const grid = document.getElementById('grid');
          attachThrottledMouseEvents(booth, offsetX, offsetY, grid);
        });

        booth.addEventListener('dblclick', function () {
          editLabel(booth.dataset.index);
        });

        grid.appendChild(booth);
      });

      updateBoothList();
    }
    
    const resizer = document.getElementById('resizer');
    const sidebar = document.getElementById('sidebar');
    const main = resizer.parentNode;

    resizer.addEventListener('mousedown', function(e) {
      e.preventDefault();

      document.addEventListener('mousemove', resizeSidebar);
      document.addEventListener('mouseup', stopResize);
    });

    function resizeSidebar(e) {
      const newWidth = e.clientX;
      if (newWidth > 150 && newWidth < 600) { // optional min/max width
        sidebar.style.width = newWidth + 'px';
      }
    }

    function stopResize() {
      document.removeEventListener('mousemove', resizeSidebar);
      document.removeEventListener('mouseup', stopResize);
    }

    function placeTextLabel() {
      const grid = document.getElementById('grid');

      grid.onclick = function(e) {
        if (!e.target.classList.contains('cell')) return;

        const rect = grid.getBoundingClientRect();
        const x = (e.clientX - rect.left) / currentZoom;
        const y = (e.clientY - rect.top) / currentZoom;
        const left = Math.round(x / cellPx) * cellPx;
        const top = Math.round(y / cellPx) * cellPx;

        const label = prompt("Enter label text (e.g., 'Entrance', 'Restroom', etc.):");
        if (!label) return;

        const textBox = document.createElement('div');
        textBox.className = 'text-label';
        textBox.style.position = 'absolute';
        textBox.style.left = left + 'px';
        textBox.style.top = top + 'px';
        textBox.style.padding = '4px 8px';
        textBox.style.background = '#ffe680';
        textBox.style.border = '1px solid #999';
        textBox.style.fontSize = '12px';
        textBox.style.cursor = 'move';
        textBox.style.zIndex = 5000;
        textBox.contentEditable = true;
        textBox.innerText = label;

        // ‚úÖ Enable click-to-select
        textBox.addEventListener('click', function(ev) {
          document.querySelectorAll('.text-label.selected').forEach(el => el.classList.remove('selected'));
          textBox.classList.add('selected');
          selectedBooth = null; // prevent conflict with booth delete
          ev.stopPropagation();
        });

        // ‚úÖ Enable drag movement
        let offsetX = 0, offsetY = 0;
        textBox.addEventListener('mousedown', function(ev) {
          const boxRect = textBox.getBoundingClientRect();
          offsetX = (ev.clientX - boxRect.left) / currentZoom;
          offsetY = (ev.clientY - boxRect.top) / currentZoom;
          attachTextMoveEvents(textBox, offsetX, offsetY);
        });

        grid.appendChild(textBox);
        grid.onclick = null; // exit placement mode
      };
    }


    function attachTextMoveEvents(el, offsetX, offsetY) {
      const grid = document.getElementById('grid');
      function move(ev) {
        const rect = grid.getBoundingClientRect();
        const x = (ev.clientX - rect.left) / currentZoom - offsetX;
        const y = (ev.clientY - rect.top) / currentZoom - offsetY;
        const snappedX = Math.round(x / cellPx) * cellPx;
        const snappedY = Math.round(y / cellPx) * cellPx;
        el.style.left = snappedX + 'px';
        el.style.top = snappedY + 'px';
      }

      function stop() {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', stop);
      }

      document.addEventListener('mousemove', move);
      document.addEventListener('mouseup', stop);
    }

</script>
  </main>
  <footer style="background:#f4f4f4;text-align:center;padding:10px;font-size:0.9em;border-top:1px solid #ccc;">
    &copy; 2025 by <a href="https://creativecosplays.com" target="_blank" style="color:#000;text-decoration:none;font-weight:bold;">Creative Cosplays</a>
  </footer>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
